#!/bin/bash -l

#SBATCH --export=USER,LOGNAME,HOME,MAIL,PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
#SBATCH --job-name=gpu_benchmark               
#SBATCH --output=out_gpu_benchmark_%j.txt
#SBATCH --partition=gpu_a100
#SBATCH --account=eccc_mrd__gpu_a100
#SBATCH --time=00:20:00
#SBATCH --ntasks=24
#SBATCH --cpus-per-gpu=32                
#SBATCH --gpus=12
#SBATCH --mem-per-gpu=40G

WX_DIR=/home/vma000/code/wx_factory_clean

cd ${WX_DIR}
. ~/launch-scripts/wx/gpsc/load_u2_env.sh

CONFIG_FILE=./tests/gpu_benchmark/config.ini

srun -n 6 ./scripts/mpi_config.py
srun -n 16 ./scripts/mpi_config.py
srun -n 24 ./scripts/mpi_config.py

echo ${CONFIG_FILE}
srun -n 6 ./WxFactory ${CONFIG_FILE} --disable-unified-memory
srun -n 24 ./WxFactory ${CONFIG_FILE} --disable-unified-memory

